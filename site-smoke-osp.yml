---
- name: smoke test
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: OpenStack servers
      os_server_info:
        cloud: openstack
        region_name: regionOne
      register: r_os_servers
    
    - name: Add host
      add_host:
       hostname: "{{ item.name }}"
       ansible_host: "{{ item.public_v4 }}"
       group: "{{ item.metadata.group }}"
       ansible_ssh_private_key_file: ~/.ssh/openstack.pem
       ansible_ssh_user: cloud-user
      loop: "{{ r_os_servers.openstack_servers }}"
    
    - name: Add host
      add_host:
       hostname: "{{ item.name }}"
       ansible_host: "{{ item.public_v4 }}"
       group: "{{ item.metadata.deployment_name }}"
       ansible_ssh_private_key_file: ~/.ssh/openstack.pem
       ansible_ssh_user: cloud-user
      loop: "{{ r_os_servers.openstack_servers }}"

    - name: test
      debug:
        msg: "{{ r_os_servers.openstack_servers.name }}"

    - name: test2
      debug:
        msg: "{{ r_os_servers.openstack_servers.name.public_v4 }}"

    - name: Curl website
      uri:
        url: "http://{{ r_os_servers.openstack_servers.name.public_v4 }}/ping"
        return_content: yes
        status_code: 200
      register: webpage
      delegate_to: localhost
      when: "{{ r_os_servers.openstack_servers.name }} == frontend"

    - name: Fail if 'Ansible has done its job' is not in the page content
      fail:
      when: "'Ansible has done its job' not in webpage.results[0].content"
      tags:
        - osp.smoke
